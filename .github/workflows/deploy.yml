name: Deploy Lambda to AWS

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - '.github/workflows/templates/lambda-template.yml'

env:
  AWS_REGION: 'us-east-1'
  LAMBDA_FUNCTION_NAME: 'cpf-cognito-lambda-handler'
  S3_BUCKET: 'cpf-cognito-lambda-artifacts'
  STACK_NAME: 'cpf-cognito-lambda-stack'

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Configurar AWS CLI
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Criar bucket S3 se n√£o existir
      run: |
        aws s3 ls s3://$S3_BUCKET || aws s3 mb s3://$S3_BUCKET --region $AWS_REGION

    - name: Criar .env dinamicamente para o package
      run: |
        echo "üîß Criando .env para o package..."
        cat > .env << EOF
        COGNITO_USER_POOL_ID=${{ secrets.COGNITO_USER_POOL_ID }}
        COGNITO_CLIENT_ID=${{ secrets.COGNITO_CLIENT_ID }}
        NODE_ENV=production
        AWS_REGION=us-east-1
        EOF
        echo "‚úÖ .env criado com sucesso!"

    - name: Instalar depend√™ncias e empacotar Lambda
      run: |
        npm ci --production
        zip -r function.zip src/ node_modules/ package.json .env
        echo "üì¶ Package criado: function.zip"

    - name: Fazer upload do c√≥digo para S3
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        aws s3 cp function.zip s3://$S3_BUCKET/function-$TIMESTAMP.zip
        echo "CODE_S3_URI=s3://$S3_BUCKET/function-$TIMESTAMP.zip" >> $GITHUB_ENV
        echo "üì§ C√≥digo enviado para S3: ${{ env.CODE_S3_URI }}"

    - name: Deploy CloudFormation Stack
      run: |
        echo "üöÄ Iniciando deploy do CloudFormation..."
        echo "üìã Par√¢metros:"
        echo "   Function: $LAMBDA_FUNCTION_NAME"
        echo "   S3 URI: ${{ env.CODE_S3_URI }}"
        echo "   User Pool: ${{ secrets.COGNITO_USER_POOL_ID }}"
        echo "   Client ID: ${{ secrets.COGNITO_CLIENT_ID }}"
        
        aws cloudformation deploy \
          --template-file .github/workflows/templates/lambda-template.yml \
          --stack-name $STACK_NAME \
          --parameter-overrides \
            FunctionName=$LAMBDA_FUNCTION_NAME \
            CodeS3Uri=${{ env.CODE_S3_URI }} \
            CognitoUserPoolId=${{ secrets.COGNITO_USER_POOL_ID }} \
            CognitoClientId=${{ secrets.COGNITO_CLIENT_ID }} \
          --capabilities CAPABILITY_NAMED_IAM

    - name: Verificar deploy
      run: |
        echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
        echo "‚úÖ Lambda: $LAMBDA_FUNCTION_NAME"
        echo "üì¶ C√≥digo: ${{ env.CODE_S3_URI }}"
        echo "üîß Stack: $STACK_NAME"
        echo "üåê Regi√£o: $AWS_REGION"