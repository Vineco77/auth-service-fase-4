name: Deploy Lambda to AWS

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'           
      - 'package.json'     
      - '.github/workflows/templates/lambda-template.yml'  

env:
  AWS_REGION: 'us-east-1'
  LAMBDA_FUNCTION_NAME: 'cpf-cognito-lambda-handler'
  S3_BUCKET: 'cpf-cognito-lambda-artifacts'
  STACK_NAME: 'cpf-cognito-lambda-stack'

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar AWS CLI
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Criar bucket S3 se nÃ£o existir
      run: |
        aws s3 ls s3://$S3_BUCKET || aws s3 mb s3://$S3_BUCKET --region $AWS_REGION

    - name: Instalar dependÃªncias e empacotar Lambda
      run: |
        npm ci --production
        zip -r function.zip src/ node_modules/ package.json .env

    - name: Fazer upload do cÃ³digo para S3
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        aws s3 cp function.zip s3://$S3_BUCKET/function-$TIMESTAMP.zip
        echo "CODE_S3_URI=s3://$S3_BUCKET/function-$TIMESTAMP.zip" >> $GITHUB_ENV

    - name: Deploy CloudFormation Stack
      run: |
        aws cloudformation deploy \
          --template-file .github/workflows/templates/lambda-template.yml \
          --stack-name $STACK_NAME \
          --parameter-overrides \
            FunctionName=$LAMBDA_FUNCTION_NAME \
            CodeS3Uri=${{ env.CODE_S3_URI }} \
            CognitoUserPoolId=${{ secrets.COGNITO_USER_POOL_ID }} \
            CognitoClientId=${{ secrets.COGNITO_CLIENT_ID }} \
          --capabilities CAPABILITY_NAMED_IAM

    - name: Verificar deploy
      run: |
        echo "âœ… Lambda deployada com sucesso!"
        echo "ðŸ“¦ CÃ³digo: ${{ env.CODE_S3_URI }}"
        echo "ðŸ”§ FunÃ§Ã£o: $LAMBDA_FUNCTION_NAME"